/***********************************************************************
/* Установка KDE
/***********************************************************************
https://wiki.archlinux.org/index.php/KDE

видео драйвер, nouveau - опенсорсный, можно проприетарный - смотри archwiki по слову nvidia
pacman --sync --needed xf86-video-nouveau mesa
pacman --sync --needed xorg-server xorg-xinit xorg-xev xorg-xinput
сейчас или позже можно установить пропатченный xorg сервер, смотри соответствующий раздел ниже

pacman --sync plasma-meta kde-applications      sddm
pacman --sync plasma-meta kde-applications-meta sddm

для ноутбука будет полезно установить
pacman --sync acpi
pacman --sync brightnessctl

systemctl enable sddm
reboot

и собственно все, готово, у нас есть KDE окружение, далее можно настраивать.
Рекомендуется установить KDE xorg patch, если его по-прежнему не замерджили в master xorg сервера

/***********************************************************************
/* KDE xorg patch
/***********************************************************************
https://aur.archlinux.org/packages/xorg-server-bug865 - фиксит конфликт переключения раскладок alt + shift и прочих комбинаций alt + shift + что-то.
До этого патча нажатие alt + shift сразу же переключает раскладу и последующее нажатие уже не воспринимается как комбинация alt + shift + что-то
С патчем же переключение происходит при key release alt + shift и если ничего другого не было нажато - все работает нормально, как на венде


ключи PGP:
gpg --recv-keys 4C09DD83CAAA50B2
gpg --lsign-key 4C09DD83CAAA50B2


# внимание в процессе переустанавливается xorg-server, причем пакет заменяется с основного на новый патченый
$ git clone https://aur.archlinux.org/xorg-server-bug865.git
$ cd xorg-server-bug865
$ makepkg --install --syncdeps --rmdeps

# restart xserver, а еще лучше систему
sudo systemctl restart sddm


/***********************************************************************
/* настройка KDE
/***********************************************************************
в system settings целом все и так понятно, тут скорее перечисление пунктов что бы не забыть + для полноты
Hardware -> Input Devices -> Keyboard
Keyboard model - asus laptop, logitech ..., что у нас есть 
Layouts - добавляем ru, Switching policy - Application, shortcut alt+shift

Touchpad - mouse click emulation, pointer motion acceleration, ...
    KDE, увы под xorg libinput предоставляет не полные настройки тачпада,
    * нужно или установить драйвер synaptics(в том числе и для elantech), после чего настройки станут редактируемыми
      sudo pacman --sync --needed xf86-input-synaptics

    * или прописать параметры для X11:
        для TappingButtonMap: lmr(left middle right) нужно создать файл /etc/X11/xorg.conf.d/30-touchpad.conf:
        Section "InputClass"
            Identifier "ETPS/2 Elantech Touchpad"
            Driver "libinput"
            MatchIsTouchpad "on"
            Option "Tapping" "on"
            Option "TappingButtonMap" "lmr"
            Option "AccelSpeed" 0.5           # заодно выставляем ускорение для тачпада
        EndSection
    
    так же можно поиграться с xinput(настройки для нее немного отличаются от xorg.conf'овых, смотри man 4 libinput)

Display - scale можно настроить, если hipdi

Power management - можно настроить всякое связанное с батареями, яркостью/затуханием экрана
Desktop behavier -> Screen Locking - Lock screen on resume
                 -> Workspace      - Double-click to open files and folders

/etc/systemd/logind.conf:
# if KDE or other desktop environment does not handle acpi events,
# systemd handles them - by default it will suspend on lid close
HandleLidSwitch=ignore

Яркость на ноубуках:
https://wiki.archlinux.org/index.php/backlight - wiki по яркости.
Если есть несколько видео карт, например, основная и интегрированная, или linux просто некорректно определил ACPI backlight устройства
linux может не сохранять яркость при перезагрузке или suspend/resume.
В случае моего ASUS N73SM помогло добавление параметра acpi_backlight=vendor в GRUB_CMDLINE_LINUX_DEFAULT -> grub-mkconfig -> перезагрузка
установка xf86-video-intel - полечило suspend/resume backlight restore

Так же в KDE powerdevil, он же system settings -> Power Management -> Energy Saving,
контролирует яркость и если включен Screen Brightness/Dim screen(а может даже всегда/обе настройки выключены) - 
он будет вмешиваться, и может сбрасывать яркость в максимум/минимум/как повезет.
Нужно выставить желаемую яркость в Energy Saving настройках

по backlight еще можно почитать:
https://wiki.ubuntu.com/Kernel/Debugging/Backlight

выключить нафиг baloo(сервис индексации файлов, по факту на слабых машинах может приводить к тормазам)
$ balooctl disable

дефолтные папки:
mkdir ~/Documents ~/Downloads ~/Music ~/Pictures ~/Videos

/***********************************************************************
/* ssh-agent
/***********************************************************************
https://wiki.archlinux.org/index.php/SSH_keys#SSH_agents Start ssh-agent with systemd user

~/.config/systemd/user/ssh-agent.service:
[Unit]
Description=SSH key agent

[Service]
Type=simple
Environment=SSH_AUTH_SOCK=%t/ssh-agent.socket
ExecStart=/usr/bin/ssh-agent -D -a $SSH_AUTH_SOCK

[Install]
WantedBy=default.target

~/.pam_environment:
SSH_AUTH_SOCK DEFAULT="${XDG_RUNTIME_DIR}/ssh-agent.socket"

/***********************************************************************
/* tearing
/***********************************************************************
https://wiki.archlinux.org/index.php/NVIDIA/Troubleshooting#Avoid_screen_tearing_in_KDE_.28KWin.29
https://www.youtube.com/watch?v=0RvIbVmCOxg&t=21s - видео для теста tearing'а

на стационарной машине с nvidia картой и KDE оболочкой частично: __GL_YIELD="USLEEP"
по ощущенияем tearing все же отсался, но его стало мало и он почит незаметен, если только приглядываться на спец видео.
!!! фигня, рвет так что гдаза вытекают, смотри ниже NVIDIA TripleBuffer.

~/.config/autostart-scripts/kwin.sh:
#!/bin/bash
(sleep 2s && __GL_YIELD="USLEEP" kwin_x11 --replace)

не забыть сделать исполняемым:
chmod +x ~/.config/autostart-scripts/kwin.sh

Помогло: /etc/X11/xorg.conf.d/20-nvidia.conf:
Section "Screen"
    Identifier     "Screen0"
    Option         "metamodes" "nvidia-auto-select +0+0 { ForceFullCompositionPipeline = On }"
    Option         "AllowIndirectGLXProtocol" "off"
    Option         "TripleBuffer" "on"
EndSection




Для intel GPU - https://wiki.archlinux.org/index.php/Intel_graphics#Tearing
/etc/X11/xorg.conf.d/20-intel.conf:
Section "Device"
  Identifier  "Intel Graphics"
  Driver      "intel"
  Option      "TearFree" "true"
EndSection


/***********************************************************************
/* Xmodmap
/***********************************************************************
https://wiki.archlinux.org/index.php/Xmodmap
переназначить клавишу на другую, полезно на некоторых клваиатурах, например logitech левый \ слеш переназначить на shift,
можно с помощью .Xmodmap

c помощью утилиты xev помжно посмотреть keycode клавиши, которую хочется переназначить,
после чего создаем ~/.Xmodmap:
keycode 94 = Shift_L

перелогиниваемся


/***********************************************************************
/* шрифты
/***********************************************************************
по умолчанию в arch linux установлены пакеты шрифтов:
ttf-noto-fonts - гугловские опенсорсные шрифты, передерживающие все или почти все юникодные символы, в целом хорошие
ttf-hack       - моноширные шрифты

этого достаточно для обычных приложений, но случае браузера - популярные шрифты такие как Ariel, Helvetica, Times New Roman работать не будут,
связанно это с тем что не настроен маппинг этих семейств в Noto Sans, вместо этого он в конечном счете идет в моноширный Hack.

pacman --sync --needed ttf-liberation ttf-dejavu
это установит ряд шрифтов и маппинги на них для Ariel, Times New Roman, ...
Возможно маппинги были и до этих пакетов, но сами шрифты доставляется именно этими пакетами


/***********************************************************************
/* GTK интеграция
/***********************************************************************
по-умолчанию порядок кнопок в GTK даилогах(Ok, Cancel, ...) обратный по отношению к винде, KDE
что бы сделать его таким же нужно добавить в 
~/.config/gtk-3.0/settings.ini:
[Settings]
gtk-alternative-button-order=1

для firefox интеграции
sudo pacman --sync --needed xdg-desktop-portal xdg-desktop-portal-kde
echo 'export GTK_USE_PORTAL=1' > ~/.config/plasma-workspace/env/gtk-use-portal.sh

/***********************************************************************
/* Google drive
/***********************************************************************
pacman --sync kio-gdrive
это добавить поддержку google drive в dolphin


/***********************************************************************
/*  NVIDIA PRIME and laptop nvidea + intel videocards
/***********************************************************************
https://wiki.archlinux.org/index.php/PRIME#PRIME_render_offload    PRIME render offload
NVIDIA driver since version 435.17 supports this method.
It needs a specific set of patches to the xorg-server that are present since version 1.20.6-1 on Arch.
As per the official documentation, it only works with the modesetting driver over Intel graphics card; success has been had with the Intel driver instead regardless. Refer to Intel graphics#Installation for more information.

The nvidia-prime package provides the Xorg configuration necessary and also a script that can be used to run programs on the NVIDIA card. 

$ prime-run glxinfo | grep "OpenGL renderer"
$ prime-run vulkaninfo

/***********************************************************************
/*  bumblebee and laptop nvidea/radeon + intel videocards
/***********************************************************************
https://wiki.archlinux.org/index.php/Bumblebee
https://wiki.archlinux.org/index.php/Xorg#Driver_installation
в моем случае все зараболо в соответсвии с интсрукциями, но драйвер нужно было поставить проприетарный - nvidia-390xx

sudo pacman --sync --needed nvidia-390xx nvidia-390xx-utils nvidia-390xx-settings
sudo modprobe nvidia -vv # смотреть выхлоп на премет ошибок
dmesg --ctime --color=always | less # смотрим лог на предмет ошибок видео драйвера, ищем по слову nvidia

sudo pacman --sync --needed bumblebee bbswitch primus
sudo gpasswd -a user bumblebee

/etc/bumblebee/bumblebee.conf:
[optirun]
Bridge=primus

sudo systemctl enable bumblebeed.service

sudo reboot

# проверяем
optirun glxgears -info
optirun glxspheres64


/***********************************************************************
/* Печать
/***********************************************************************
# нужно установить cups пакет
pacman --sync cups

# Добавляем пользователя в группу sys, что бы иметь адмиский доступ(добавление принтеров, прочее)
usermod -a -G sys $user

# для некоторых принтеров нужно установить драйверы из aur, например samsung'и:
git clone https://aur.archlinux.org/samsung-unified-driver.git
cd samsung-unified-driver
makepkg --install --syncdeps --rmdeps 

systemctl enable org.cups.cupsd.service
systemctl start  org.cups.cupsd.service

firefox localhost:631/admin - добавляем принтеры


/***********************************************************************
/* Bluetooth headset
/***********************************************************************
https://wiki.archlinux.org/index.php/Bluetooth_headset
pacman --sync pulseaudio-alsa pulseaudio-bluetooth bluez bluez-libs bluez-utils
systemctl enable --now bluetooth.service

bluetoothctl
[bluetooth]# power on
[bluetooth]# agent on
[bluetooth]# default-agent
[bluetooth]# scan on

если устройства будут найдены - будет вывод в консоль

[bluetooth]# connect XX:XX:XX...
[bluetooth]# trust   XX:XX:XX...


If you're getting a connection error org.bluez.Error.Failed retry by killing existing PulseAudio daemon first:
$ pulseaudio -k
[bluetooth]# connect 00:1D:43:6D:03:26



/etc/bluetooth/main.conf:
[Policy]
AutoEnable=true

/etc/pulse/default.pa:
# automatically switch to newly-connected devices
load-module module-switch-on-connect


При повторном подключении возможно что наушники будут подключаться HFP профилем вместо A2DP
в вики есть описание как можно это обходить, помогло explicit:
$ bluetoothctl connect XX:XX:XX
$ pacmd set-card-profile card_number bluez_card.XX_XX... a2dp_sink
